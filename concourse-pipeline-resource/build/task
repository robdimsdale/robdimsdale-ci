#!/bin/bash

set -eux

root_dir="${PWD}"

# Inputs
CONCOURSE_PIPELINE_RESOURCE_DIR="${root_dir}/${CONCOURSE_PIPELINE_RESOURCE_DIR:?"\$CONCOURSE_PIPELINE_RESOURCE_DIR not set"}"
FLY_BINARY_DIR="${root_dir}/${FLY_BINARY_DIR:?"\$FLY_BINARY_DIR not set"}"
VERSION_DIR="${root_dir}/${VERSION_DIR:?"\$VERSION_DIR not set"}"

# Outputs
BUILT_BINARIES_DIR="${root_dir}/${BUILT_BINARIES_DIR:?"\$BUILT_BINARIES_DIR not set"}"
BUILD_OUTPUT_DIR="${root_dir}/${BUILD_OUTPUT_DIR:?"\$BUILD_OUTPUT_DIR not set"}"

full_version=$(cat "${VERSION_DIR}/version")
if [ -z "${full_version}" ]; then
  echo "missing version file"
  exit 1
fi

IFS='-' read -ra arr_full_version <<< "${full_version}"
stripped_version="${arr_full_version[0]}"

export VERSION="${stripped_version}"

export GOPATH="${PWD}/gopath"
export PATH="${GOPATH}/bin:${PATH}"

cp \
  "${FLY_BINARY_DIR}/fly" \
  "${CONCOURSE_PIPELINE_RESOURCE_DIR}/fly-bin"

"${CONCOURSE_PIPELINE_RESOURCE_DIR}/scripts/build" "$@"

cp -r \
  "${CONCOURSE_PIPELINE_RESOURCE_DIR}/"* \
  "${BUILD_OUTPUT_DIR}/"

cp \
  "${CONCOURSE_PIPELINE_RESOURCE_DIR}/cmd/check/check" \
  "${BUILT_BINARIES_DIR}/check"

cp \
  "${CONCOURSE_PIPELINE_RESOURCE_DIR}/cmd/in/in" \
  "${BUILT_BINARIES_DIR}/in"

cp \
  "${CONCOURSE_PIPELINE_RESOURCE_DIR}/cmd/out/out" \
  "${BUILT_BINARIES_DIR}/out"
