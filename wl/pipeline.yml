---
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource

resources:
- name: robdimsdale-ci
  type: git
  source:
    branch: master
    uri: https://github.com/robdimsdale/robdimsdale-ci.git

- name: wl
  type: git
  source:
    uri: git@github.com:robdimsdale/wl
    branch: develop
    private_key: {{private-key}}

- name: wl-master
  type: git
  source:
    uri: git@github.com:robdimsdale/wl
    branch: master
    private_key: {{private-key}}

- name: homebrew-tap
  type: git
  source:
    uri: git@github.com:robdimsdale/homebrew-tap
    branch: master
    private_key: {{homebrew-tap-private-key}}

- name: slack-alert
  type: slack-notification
  source:
    url: {{slack-url}}

- name: tracker
  type: tracker
  source:
    token: {{tracker-token}}
    project_id: {{tracker-project-id}}
    tracker_url: https://www.pivotaltracker.com

- name: time-trigger
  type: time
  source: {interval: 12h}

- name: version
  type: semver
  source:
    bucket: wl-releases
    key: current-version
    access_key_id: {{pipeline-bucket-access-key}}
    secret_access_key: {{pipeline-bucket-secret-key}}

- name: wl-release-linux-amd64
  type: s3
  source:
    bucket: wl-releases
    regexp: wl-linux-amd64-(.*)
    access_key_id: {{pipeline-bucket-access-key}}
    secret_access_key: {{pipeline-bucket-secret-key}}

- name: wl-release-darwin-amd64
  type: s3
  source:
    bucket: wl-releases
    regexp: wl-darwin-amd64-(.*)
    access_key_id: {{pipeline-bucket-access-key}}
    secret_access_key: {{pipeline-bucket-secret-key}}

- name: wl-release-windows-amd64
  type: s3
  source:
    bucket: wl-releases
    regexp: wl-windows-amd64-(.*)
    access_key_id: {{pipeline-bucket-access-key}}
    secret_access_key: {{pipeline-bucket-secret-key}}

- name: github-release
  type: github-release
  source:
    access_token: {{github-release-access-token}}
    repository: wl
    user: robdimsdale

jobs:
- name: test
  public: true
  plan:
  - do:
    - aggregate:
      - get: robdimsdale-ci
      - get: wl
        trigger: true
      - get: time-trigger
        trigger: true
    - aggregate:
      - task: unit-tests
        file: robdimsdale-ci/wl/unit/task.yml
      - task: integration-tests
        file: robdimsdale-ci/wl/integration/task.yml
        params:
          WL_ACCESS_TOKEN: {{wl-access-token}}
          WL_CLIENT_ID: {{wl-client-id}}
    on_failure:
      put: slack-alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-failure-text}}

- name: rc
  serial_groups: [version]
  public: true
  plan:
  - do:
    - aggregate:
      - get: robdimsdale-ci
      - get: wl
        passed: [test]
        trigger: true
      - get: version
        params: {pre: rc}
    - aggregate:
      - task: create-linux-amd64
        file: robdimsdale-ci/wl/create-rc/task.yml
        params:
          GOOS: linux
          GOARCH: amd64
        output_mapping: {wl-rc: wl-rc-linux-amd64}
      - task: create-darwin-amd64
        file: robdimsdale-ci/wl/create-rc/task.yml
        params:
          GOOS: darwin
          GOARCH: amd64
        output_mapping: {wl-rc: wl-rc-darwin-amd64}
      - task: create-windows-amd64
        file: robdimsdale-ci/wl/create-rc/task.yml
        params:
          GOOS: windows
          GOARCH: amd64
        output_mapping: {wl-rc: wl-rc-windows-amd64}
    - aggregate:
      - put: version
        params: {file: version/number}
      - put: tracker
        params:
          repos: [wl]
      - put: wl-release-linux-amd64
        params: {file: wl-rc-linux-amd64/wl-linux-*}
      - put: wl-release-darwin-amd64
        params: {file: wl-rc-darwin-amd64/wl-darwin-*}
      - put: wl-release-windows-amd64
        params: {file: wl-rc-windows-amd64/wl-windows-*}
    on_failure:
      put: slack-alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-failure-text}}
    on_success:
      put: slack-alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{rc-slack-success-text}}

- name: shipit
  serial_groups: [version]
  public: true
  plan:
  - do:
    - aggregate:
      - get: robdimsdale-ci
      - get: wl
        passed: [rc]
      - get: version
        passed: [rc]
        params: {bump: final}
      - get: wl-release-linux-amd64
        passed: [rc]
      - get: wl-release-darwin-amd64
        passed: [rc]
      - get: wl-release-windows-amd64
        passed: [rc]
    - aggregate:
      - task: finalize-rc-linux-amd64
        file: robdimsdale-ci/wl/finalize-rc/task.yml
        params:
          GOOS: linux
          GOARCH: amd64
        input_mapping: {wl-rc: wl-release-linux-amd64}
        output_mapping: {wl-final: wl-linux-amd64}
      - task: finalize-rc-darwin-amd64
        file: robdimsdale-ci/wl/finalize-rc/task.yml
        params:
          GOOS: darwin
          GOARCH: amd64
        input_mapping: {wl-rc: wl-release-darwin-amd64}
        output_mapping: {wl-final: wl-darwin-amd64}
      - task: finalize-rc-windows-amd64
        file: robdimsdale-ci/wl/finalize-rc/task.yml
        params:
          GOOS: windows
          GOARCH: amd64
        input_mapping: {wl-rc: wl-release-windows-amd64}
        output_mapping: {wl-final: wl-windows-amd64}
    - aggregate:
      - put: version
        params: {file: version/number}
      - put: wl-master
        params:
          repository: wl
          tag: version/number
          tag_prefix: v
      - put: wl-release-linux-amd64
        params: {file: wl-linux-amd64/wl-linux-*}
      - put: wl-release-darwin-amd64
        params: {file: wl-darwin-amd64/wl-darwin-*}
      - put: wl-release-windows-amd64
        params: {file: wl-windows-amd64/wl-windows-*}
    on_failure:
      put: slack-alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-failure-text}}

- name: github-release
  public: true
  plan:
  - do:
    - aggregate:
      - get: robdimsdale-ci
      - get: wl
        passed: [shipit]
        trigger: true
      - get: wl-master
        passed: [shipit]
        trigger: true
      - get: wl-release-linux-amd64
        passed: [shipit]
        trigger: true
      - get: wl-release-darwin-amd64
        passed: [shipit]
        trigger: true
      - get: wl-release-windows-amd64
        passed: [shipit]
        trigger: true
      - get: version
        passed: [shipit]
        trigger: true
    - task: create-tag-prefix-file
      config:
        platform: linux
        image_resource:
          type: docker-image
          source: {repository: concourse/static-golang}
        inputs: [{name: version}]
        outputs: [{name: tag}]
        run:
          path: "/bin/sh"
          args:
          - -c
          - |
            set -x
            echo -n "v$(cat version/version)" > tag/tag
    - put: github-release
      params:
        name: tag/tag
        tag: tag/tag
        globs:
        - wl-release-linux-amd64/wl-*
        - wl-release-darwin-amd64/wl-*
        - wl-release-windows-amd64/wl-*
    on_failure:
      put: slack-alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-failure-text}}

- name: homebrew
  public: true
  plan:
  - do:
    - aggregate:
      - get: robdimsdale-ci
      - get: wl
        passed: [github-release]
        trigger: true
      - get: homebrew-tap
      - get: github-release
        passed: [github-release]
        trigger: true
    - task: create-homebrew-formula
      file: robdimsdale-ci/wl/create-homebrew-formula/task.yml
    - put: homebrew-tap
      params:
        repository: homebrew-tap-updated
    on_failure:
      put: slack-alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-failure-text}}

- name: major
  public: true
  serial_groups: [version]
  plan:
  - get: version
    params: {bump: major}
  - put: version
    params: {file: version/number}

- name: minor
  public: true
  serial_groups: [version]
  plan:
  - get: version
    params: {bump: minor}
  - put: version
    params: {file: version/number}

- name: patch
  public: true
  serial_groups: [version]
  plan:
  - get: version
    params: {bump: patch, pre: rc}
  - put: version
    params: {file: version/number}

- name: auto-patch
  public: true
  serial_groups: [version]
  plan:
  - get: version
    passed: [github-release]
    params: {bump: patch, pre: rc}
    trigger: true
  - put: version
    params: {file: version/version}

groups:
- name: wl
  jobs:
  - test
  - rc
  - shipit
  - github-release
  - homebrew
  - major
  - minor
  - patch
