---
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource

resources:
- name: robdimsdale-ci
  type: git
  source:
    uri: https://github.com/robdimsdale/robdimsdale-ci
    branch: master

- name: website-develop
  type: git
  source:
    uri: git@github.com:robdimsdale/blog
    branch: develop
    private_key: ((rmd-blog-ci-private-key/Notes))

- name: website-master
  type: git
  source:
    uri: git@github.com:robdimsdale/blog
    branch: master
    private_key: ((rmd-blog-ci-private-key/Notes))

- name: slack_alert
  type: slack-notification
  source:
    url: ((rmd-blog-ci/Notes/slack-url))

jobs:
- name: build-deploy-site-develop
  public: true
  serial: true
  plan:
  - aggregate:
    - get: robdimsdale-ci
    - get: website
      resource: website-develop
      trigger: true
  - do:
    - task: build-site
      file: robdimsdale-ci/rmd-blog/build_site/task.yml
    - task: deploy-site
      file: robdimsdale-ci/rmd-blog/deploy_site/task.yml
      input_mapping:
        website: website-built
      params:
        CF_USER: ((rmd-blog-ci/Notes/cf-user))
        CF_PASSWORD: ((rmd-blog-ci/Notes/cf-password))
        CF_ORG: ((rmd-blog-ci/Notes/cf-org-develop))
        CF_SPACE: ((rmd-blog-ci/Notes/cf-space-develop))
        CF_APPLICATION: ((rmd-blog-ci/Notes/cf-application-develop))
        STATIC_FILE_AUTH: ((rmd-blog-ci/Notes/static-file-auth-develop))
    on_success:
      put: slack_alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: ((rmd-blog-ci/Notes/slack-channel))
        text: ((rmd-blog-ci/Notes/slack-develop-success-text))
    on_failure:
      put: slack_alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: ((rmd-blog-ci/Notes/slack-channel))
        text: ((rmd-blog-ci/Notes/slack-develop-failure-text))

- name: build-deploy-site-master
  public: true
  serial: true
  plan:
  - aggregate:
    - get: robdimsdale-ci
    - get: website
      resource: website-master
      trigger: true
  - do:
    - task: build-site
      file: robdimsdale-ci/rmd-blog/build_site/task.yml
    - task: deploy-site
      file: robdimsdale-ci/rmd-blog/deploy_site/task.yml
      input_mapping:
        website: website-built
      params:
        CF_USER: ((rmd-blog-ci/Notes/cf-user))
        CF_PASSWORD: ((rmd-blog-ci/Notes/cf-password))
        CF_ORG: ((rmd-blog-ci/Notes/cf-org-master))
        CF_SPACE: ((rmd-blog-ci/Notes/cf-space-master))
        CF_APPLICATION: ((rmd-blog-ci/Notes/cf-application-master))
        STATIC_FILE_AUTH: ((rmd-blog-ci/Notes/static-file-auth-master))
    on_success:
      put: slack_alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: ((rmd-blog-ci/Notes/slack-channel))
        text: ((rmd-blog-ci/Notes/slack-master-success-text))
    on_failure:
      put: slack_alert
      params:
        silent: true
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: ((rmd-blog-ci/Notes/slack-channel))
        text: ((rmd-blog-ci/Notes/slack-master-failure-text))
